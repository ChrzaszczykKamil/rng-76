<html>
    <head>
        <title>Fallout 76 Drop Chances</title>
        <style>
            * {
                font-family: sans-serif;
                font-size: 20px;
            }
            td {
                padding: 2px;
            }
            
            table.infoTable {
               border: 1px solid black;
               border-collapse: collapse;
            }
            table.infoTable td {
               border: 1px solid black;
            }
        </style>
        <meta name="keywords" content="Fallout,Fallout 76,RNG,Random,Chances,Leveled,Leveled List,LVLI,Datamine">
    </head>
    <body>
        <center>
            <span style="font-size: 36px; font-weight: bold;">Fallout 76 Drop Chances (0.0.1)</span><br/>
            <br/>
            <br/>
            Select version:
            <select id='versionselect'>
                <option value='P19' selected='selected'>Update 19: 19th May, 2020 (latest)</option>
            </select>
            &nbsp;&nbsp;
            <button id='loadversion'>Load</button>
            <!-- &nbsp; (Note that the site downloads up to 3MB of data for the selected version!) -->
            <hr>
            <table>
                <tr>
                    <td id='listsearchtip'>
                    </td>
                    <td>
                        <input id='listsearchterm' type='text' style='width: 300px;' value='*fasnacht*'>&nbsp;<button id='listsearchbtn'>Find</button>
                    </td>
                    <td style='width: 30px;'></td>
                    <td id='itemsearchtip'>

                    </td>
                    <td>
                        <input id='itemsearchterm' type='text' style='width: 300px;' value='*raven*'>&nbsp;<button id='itemsearchbtn'>Find</button>
                    </td>
                    <td style='padding-left: 30px'>
                        <button id='clearResults'>Clear results</button>
                    </td>
                </tr>
                <tr>
                    <td colspan='5' style='text-align: center;'>
                        <input type='checkbox' id='IncludeATX' checked><label for='IncludeATX'>Include Atom Shop</label>&nbsp;&nbsp;&nbsp;
                        <input type='checkbox' id='IncludeCut'><label for='IncludeCut'>Include cut content</label>&nbsp;&nbsp;&nbsp;
                        <input type='checkbox' id='IncludeDebug'><label for='IncludeDebug'>Include debug content</label>&nbsp;&nbsp;&nbsp;
                        <input type='checkbox' id='SortByEditorID' checked><label for='SortByEditorID'>Sort by EditorID</label>&nbsp;&nbsp;&nbsp;
                    </td>
                </tr>
            </table>
            <hr>
            <table id='searchresults'>

            </table>
            <hr>
            <a id='tableLink' href="#" target="_blank" style='display: none;'>Link to the selected setup below:</a><br/><br/>
            <table id='listtable'>

            </table>
        </center>
        <script>
            // property key is the FormID, property value is the Group string (4chars) concatenated with the EditorID
            var edids = {};
            // property key is the FormID, property value is the global float
            var globals = {};
            // property key is the FormID, property value is the leveled list object
            var leveledLists = {};
            // property key is the FormID, property value is an array of objects with the form { "x": 0, "y" : 0 }
            var curves = {};

            var downloadDone = 0;

            function allDownloaded() {
                document.getElementById("loadversion").disabled = false;
                // TODO 
                console.log(Object.keys(edids).length);
                console.log(Object.keys(globals).length);
                console.log(Object.keys(leveledLists).length);
                console.log(Object.keys(curves).length);

                // find cross references
                for (var listID in leveledLists) {

                    var lvli = leveledLists[listID];

                    if (lvli.Entries !== undefined) {
                        for (var entry of lvli.Entries) {

                            var refList = leveledLists[entry.Object];

                            if (refList !== undefined) {
                                if (refList.Parents === undefined) {
                                    refList.Parents = [];
                                }
                                refList.Parents.push(listID);
                            }
                        }
                    }
                }

                var q = location.search;
                if (q.includes("formids=")) {
                    var idx = q.indexOf("formids=");
                    var ids = q.substr(idx + 8).split("-");
                    recreateMainTable(ids);
                }
            }

            function loadScript(src, callback) {
                var r = false;
                var s = document.createElement('script');
                s.type = 'text/javascript';
                s.src = src;
                s.onload = s.onreadystatechange = function() {
                    //console.log( this.readyState ); //uncomment this line to see which ready states are called.
                    if ( !r && (!this.readyState || this.readyState == 'complete') ) {
                        r = true;
                        callback(s);
                    }
                };
                var t = document.getElementsByTagName('script')[0];
                t.parentNode.insertBefore(s, t);
            }

            function doLoad() {
                document.getElementById("loadversion").disabled = true;

                var versionSelect = document.getElementById("versionselect");
                if (versionSelect.selectedIndex >= 0) {
                    downloadDone = 4;
                    var patchPrefix = 
                        // "https://akarnokd.github.com/rng-76/" +
                        versionSelect.options[versionSelect.selectedIndex].value + "_";

                    loadScript(patchPrefix + "SeventySix_EDIDs.js", node => {
                        if (--downloadDone == 0) {
                           allDownloaded();
                        }
                    });
                    loadScript(patchPrefix + "SeventySix_GLOBs.js", node => {
                        if (--downloadDone == 0) {
                           allDownloaded();
                        }
                    });
                    loadScript(patchPrefix + "SeventySix_LVLIs.js", node => {
                        if (--downloadDone == 0) {
                           allDownloaded();
                        }
                    });
                    loadScript(patchPrefix + "SeventySix_CURVs.js", node => {
                        if (--downloadDone == 0) {
                           allDownloaded();
                        }
                    });
                }
            }


            document.getElementById("loadversion").onclick = doLoad;

            var infoMap = new Map();
            infoMap.set("ListSearch", 
                "Enter the FormID (leading zeros can be omitted) or Editor ID of the leveled list to find."
                + "<br>Use * to indicate a wildcard (e.g., *Fasnacht*)."
                + "<br>Use commas to list alternative options."
                + "<br>Spaces and capitalization are ignored."
            );
            infoMap.set("ItemSearch", 
                "Enter the FormID (leading zeros can be omitted) or Editor ID of the item you want to locate in the leveled lists."
                + "<br>Use * to indicate a wildcard (e.g., *Fixer*)."
                + "<br>Use commas to list alternative options."
                + "<br>Spaces and capitalization are ignored."
            );

            // add HTML explanation marker
            function info(name) {
                return "&nbsp;<sup><a href='#' style='font-size: 14; font-weight: bold;' onclick='showinfo(this, \"" + name + "\"); return false;'>Tip</a></sup>";
            }

            // popup for explanation
            function showinfo(target, name) {
                var div = document.getElementById("InfoDiv" + name);
                if (div == null) {
                    var div = document.createElement("div");
                    div.style.border = "1px solid black";
                    div.style.padding = "3px";
                    div.style.position = "absolute";
                    div.style.backgroundColor = "#FFFFD0";
                    div.style.zIndex = 99;
                    div.id = "InfoDiv" + name;
                    var txt = infoMap.get(name);

                    if (txt == null) {
                        txt = "??? " + name + " ???";
                    }
                    txt += "<hr><font style='font-size: 14px'>Click to close.</font>";
                    div.innerHTML = txt;

                    target.parentElement.appendChild(div);
                    div.onclick = function() {
                        target.parentElement.removeChild(div);
                    }
                } else {
                    target.parentElement.removeChild(div);
                }
            }

            document.getElementById("listsearchtip").innerHTML = "Search leveled list " + info("ListSearch");
            document.getElementById("itemsearchtip").innerHTML = "Search item in lists " + info("ItemSearch");

            // paging support
            var searchResults = [];

            function parseSearchText(text) {

                var result = text.split(",");
                for (var i = 0; i < result.length; i++) {
                    // remove spaces
                    var entry = result[i];

                    entry = entry.replace(" ", "");;
                    entry = entry.replace(/\*/g, ".*");
                    entry = entry.replace(/^0+/, "");
                    entry = entry.toLowerCase();

                    result[i] = new RegExp("^" + entry + "$");
                }

                return result;
            }

            function getEditorID(formID) {
                var result = edids[formID];
                if (result !== undefined) {
                    return result.substring(4);
                }
                return "";
            }

            function getGroupID(formID) {
                var result = edids[formID];
                if (result !== undefined) {
                    return result.substring(0, 4);
                }
                return "";
            }

            function createListLink(formID, text) {
                return "<a href='#' onclick='showList(\"" + formID + "\"); return false;'>" + text + "</a>";
            }

            function interpolate(curveTable, x) {
                var first = curveTable[0];
                if (x <= first.x) {
                    return first.y;
                }
                var last = curveTable[curveTable.length - 1];
                if (last <= x) {
                    return last.y;
                }
                for (var i = 0; i < curveTable.length - 1; i++) {
                    var curr = curveTable[i];
                    var next = curveTable[i + 1];

                    if (curr.x <= x && x < next.x) {
                        var step = next.x - curr.x;
                        var raise = next.y - curr.y;

                        var xrate = (x - curr.x) / step;

                        var yrate = curr.y + raise * xrate;

                        return yrate;
                    }
                }
                return NaN;
            }

            function decodeValue(entry, keyDirect, keyGlobal, keyCurve) {
                var curveID = entry[keyCurve];
                var globalID = entry[keyGlobal];
                if (curveID !== undefined) {
                    var curveTable = curves[curveID];
                    if (curveTable !== undefined) {
                        if (globalID !== undefined) {
                            var globalValue = globals[globalID];
                            if (globalValue !== undefined) {
                                var v = interpolate(curveTable, globalValue);                            
                                return {
                                    type: "Curve",
                                    id: curveID,
                                    g: globalID,
                                    x: globalValue,
                                    value: v
                                };
                            }

                            return {
                                type: "Curve",
                                id: curveID,
                                x: globalID,
                                error: "Global value not found"
                            };
                        }
                        return {
                            type: "Curve",
                            id: curveID,
                            error: "Global reference entry missing"
                        }
                    }
                    return {
                        type: "Curve",
                        id: curveID,
                        error: "Curve table not found."
                    }
                }
                if (globalID !== undefined) {
                    var globalValue = globals[globalID];
                    if (globalValue !== undefined) {
                        return {
                            type: "Global",
                            id: globalID,
                            value: globalValue
                        };
                    }
                    return {
                        type: "Global",
                        id: globalID,
                        error: "Global value not found"
                    }
                }

                var direct = entry[keyDirect];
                if (direct === undefined) {
                    direct = 0;
                }

                return {
                    type: "Constant",
                    value: direct
                };
            }

            function createNukaLink(formID) {
                return "<a href='https://nukacrypt.com/database/json/" + formID + "' target='_blank' title='See Nukacrypt data.'>&#x2622;&nbsp;"
                    + getGroupID(formID) + ":" + formID + " &lt;" + getEditorID(formID) + "&gt;"
                    + "</a>";
            }

            function buildConditionEntry(parent, entry, maxCols) {
                if (entry.Conditions !== undefined) {
                    n = parent.rows.length;
                    row = parent.insertRow(n);
                    cll = row.insertCell(row.cells.length);
                    cll.colSpan = maxCols;
                    cll.style.paddingLeft = "60px";

                    var innerTbl = document.createElement("table");
                    innerTbl.style.width = "100%";
                    cll.appendChild(innerTbl);

                    row = innerTbl.insertRow(0);
                    cll = row.insertCell(0);

                    cll.innerText = "Conditions (" + entry.Conditions.length + ")";
                    cll.style.backgroundColor = "#FFC0FF";
                    cll.style.fontWeight = "bold";

                    for (var cond of entry.Conditions) {
                        row = innerTbl.insertRow(innerTbl.rows.length);
                        cll = row.insertCell(0);

                        cll.style.backgroundColor = "E0E0E0";

                        var txt = "&nbsp;&nbsp;&nbsp;<b>" + cond.FunctionName + "</b>";

                        if (cond.FunctionName === "HasLearnedRecipe") {
                            txt += "(" + createNukaLink(cond.Param1Ref) + ")";
                        }

                        cll.innerHTML = txt;

                        if (entry.Conditions.length > 1) {
                            row = innerTbl.insertRow(innerTbl.rows.length);
                            cll = row.insertCell(0);
                            cll.style.textAlign = "center";
                            cll.style.fontWeight = "bold";

                            if ((cond.Operator & 1) == 0) {
                                cll.innerText = "{ AND }";
                            } else {
                                cll.innerText = "{ OR }";
                            }

                        }
                    }
                }
            }

            function buildValueEntry(parent, omiss, maxCols, title, formatter) {
                n = parent.rows.length;
                row = parent.insertRow(n);
                cll = row.insertCell(row.cells.length);
                cll.colSpan = maxCols;
                cll.style.paddingLeft = "60px";

                var innerTbl = document.createElement("table");
                innerTbl.style.borderCollapse = "collapse";
                innerTbl.style.width = "100%";
                cll.appendChild(innerTbl);

                row = innerTbl.insertRow(0);
                cll = row.insertCell(0);

                cll.style.backgroundColor = "C0FFC0";

                var omissSpacer = "<br><span style='margin-left: 20px;'></span>";

                if (omiss.type === "Constant") {
                    cll.innerHTML = title + " (constant): <b>" + formatter(omiss.value) + "</b>";
                }
                else if (omiss.type === "Global") {
                    if (omiss.error === undefined) {
                        cll.innerHTML = title + " (global): <b>" + formatter(omiss.value) + "</b>" + omissSpacer
                            + createNukaLink(omiss.id)
                        ;
                    } else {
                        cll.innerHTML = title + " (global): <b style='color: red;'>" + omiss.error + "</b>" + omissSpacer
                            + createNukaLink(omiss.id)
                        ;
                    }
                }
                else if (omiss.type == "Curve") {
                    if (omiss.error === undefined) {
                        cll.innerHTML = title + " (curve): <b>" + formatter(omiss.value) + "</b>" + omissSpacer
                            + "Table: " + createNukaLink(omiss.id) + omissSpacer
                            + "Global: " + createNukaLink(omiss.g) + " = " + omiss.x
                        ;
                    } else {
                        cll.innerHTML = title + " (curve): <b style='color: red;'>" + omiss.error + "</b>" + omissSpacer
                            + "Table: " + createNukaLink(omiss.id)
                            + "Global: " + createNukaLink(omiss.g)
                        ;
                    }
                }
            }

            function checkConditionsMutual(conditionList) {
                if (conditionList !== undefined) {
                    for (var ce of conditionList) {
                        if (ce.FunctionName === "EditorLocationHasKeyword") {
                            return true;
                        }
                        // TODO expand as necessary
                    }
                }
                return false;
            }

            
            function generateTable(parent, formIDs, index, parentChance) {
                var formID = formIDs[index];

                var lvli = leveledLists[formID];
                var maxCols = 5;

                var n = parent.rows.length;
                var row = parent.insertRow(n);
                var cll = row.insertCell(row.cells.length);
                cll.innerHTML = getGroupID(formID) + ":" + formID + " &lt;" + getEditorID(formID) + "&gt; "
                    + "<a href='https://nukacrypt.com/database/json/" + formID + "' target='_blank' title='See Nukacrypt data.'>&#x2622;</a>"
                ;
                cll.style.backgroundColor = "#FFCC00";
                cll.style.fontWeight = "bold";
                cll.colSpan = maxCols;

                if (lvli === undefined) {
                    n = parent.rows.length;
                    row = parent.insertRow(n);
                    cll = row.insertCell(row.cells.length);

                    cll.innerText = "Table " + formID + " not found.";
                } else {
                    var omissChanceList = decodeValue(lvli, "LVCV", "LVLG", "LVCT");
                    buildValueEntry(parent, omissChanceList, maxCols, "Omission chance", value => value.toFixed(3) + "%");

                    var maxValueList = decodeValue(lvli, "LVMV", "LVMG", "LVMT");
                    buildValueEntry(parent, maxValueList, maxCols, "Max value", value => value + "");
                    var flagsList = lvli["LVLF"];

                    n = parent.rows.length;
                    row = parent.insertRow(n);
                    cll = row.insertCell(row.cells.length);
                    cll.style.paddingLeft = "60px";
                    cll.colSpan = maxCols;
                    
                    var innerTbl = document.createElement("table");
                    innerTbl.style.borderCollapse = "collapse";
                    innerTbl.style.width = "100%";
                    cll.appendChild(innerTbl);

                    row = innerTbl.insertRow(0);
                    cll = row.insertCell(0);
                    cll.style.backgroundColor = "C0FFC0";
                    var flagsTxt = "Flags (" + flagsList + "): ";

                    if ((flagsList & 1) != 0) {
                        flagsTxt += "<b>+level</b> "
                    }
                    if ((flagsList & 2) != 0) {
                        flagsTxt += "<b>+each</b> "
                    }
                    if ((flagsList & 4) != 0) {
                        flagsTxt += "<b>+all</b> "
                    }
                    if ((flagsList & 8) != 0) {
                        flagsTxt += "<b>+u3</b> "
                    }
                    if ((flagsList & 16) != 0) {
                        flagsTxt += "<b>+refspawn</b> "
                    }
                    if ((flagsList & 32) != 0) {
                        flagsTxt += "<b>+u5</b> "
                    }
                    if ((flagsList & 64) != 0) {
                        flagsTxt += "<b>+first-match-all-conditons</b> "
                    }
                    if ((flagsList & 128) != 0) {
                        flagsTxt += "<b>+u7</b> "
                    }


                    cll.innerHTML = flagsTxt;

                    if (lvli.Parents !== undefined) {
                        var n = parent.rows.length;
                        var row = parent.insertRow(n);
                        var cll = row.insertCell(row.cells.length);
                        cll.colSpan = maxCols;
                        cll.innerText = "Referenced from (" + lvli.Parents.length + ")";
                        cll.style.backgroundColor = "#C0FFFF";
                        cll.style.fontWeight = "bold";

                        for (var ref of lvli.Parents) {
                            n = parent.rows.length;
                            row = parent.insertRow(n);

                            cll = row.insertCell(row.cells.length);

                            cll = row.insertCell(row.cells.length);
                            cll.style.fontFamily = "monospace";
                            cll.innerHTML = createListLink(ref, ref);

                            cll = row.insertCell(row.cells.length);
                            cll.style.fontFamily = "monospace";
                            cll.innerHTML = createListLink(ref, getEditorID(ref));

                            cll = row.insertCell(row.cells.length);
                            cll.innerHTML = "<a href='https://nukacrypt.com/database/json/" + ref + "' target='_blank' title='See Nukacrypt data.'>&#x2622;</a>"

                            cll = row.insertCell(row.cells.length);

                            var btn = document.createElement("button");
                            cll.appendChild(btn);

                            btn.innerText = "Chain";

                            let newFormIDs = [];
                            newFormIDs.push(ref);
                            for (var fi = index; fi < formIDs.length; fi++) {
                                newFormIDs.push(formIDs[fi]);
                            }

                            btn.onclick = function() {
                                recreateMainTable(newFormIDs);
                            };
                            if (index > 0 && formIDs[index - 1] == ref) {
                                btn.disabled = true;
                            }
                        }
                    }

                    if (lvli.Conditions !== undefined) {
                        n = parent.rows.length;
                        row = parent.insertRow(n);
                        cll = row.insertCell(row.cells.length);

                        cll.innerText = "Conditions (" + lvli.Conditions.length + ")";
                        cll.style.backgroundColor = "#C0C0FF";
                        cll.style.fontWeight = "bold";
                        cll.colSpan = maxCols;
                    }
                    if (lvli.Entries !== undefined) {

                        var flagsUseAll = (flagsList & 4) != 0;
                        var max = maxValueList.value;

                        var firstPickFromAll = flagsUseAll && max === 1;
                        var useAll = flagsUseAll && max === 0;
                        var pickUniformRandom = !flagsUseAll;

                        var picksSoFar = 1;

                        n = parent.rows.length;
                        row = parent.insertRow(n);
                        cll = row.insertCell(row.cells.length);

                        cll.innerText = "Entries (" + lvli.Entries.length + ")";
                        cll.style.backgroundColor = "#C0C0FF";
                        cll.style.fontWeight = "bold";
                        cll.colSpan = maxCols;

                        for (var entry of lvli.Entries) {
                            n = parent.rows.length;
                            row = parent.insertRow(n);

                            var objectID = entry.Object;
                            var objectEDIDFull = edids[objectID];
                            var objectGroup = "";
                            var objectName = "";
                            if (objectEDIDFull !== undefined) {
                                objectGroup = objectEDIDFull.substring(0, 4);
                                objectName = objectEDIDFull.substring(4);
                            }

                            cll = row.insertCell(row.cells.length);
                            cll.style.fontFamily = "monospace";
                            cll.innerText = objectGroup;

                            cll = row.insertCell(row.cells.length);
                            cll.style.fontFamily = "monospace";
                            if (objectGroup == "LVLI") {
                                cll.innerHTML = createListLink(objectID, objectID);
                            } else {
                                cll.innerText = objectID;
                            }

                            cll = row.insertCell(row.cells.length);
                            cll.style.fontFamily = "monospace";
                            if (objectGroup == "LVLI") {
                                cll.innerHTML = createListLink(objectID, objectName);
                            } else {
                                cll.innerText = objectName;
                            }

                            cll = row.insertCell(row.cells.length);
                            cll.innerHTML = "<a href='https://nukacrypt.com/database/json/" + objectID + "' target='_blank' title='See Nukacrypt data.'>&#x2622;</a>"

                            if (objectGroup == "LVLI") {
                                cll = row.insertCell(row.cells.length);
                                var btn = document.createElement("button");
                                btn.innerText = "Open";
                                cll.appendChild(btn);

                                let newFormIDs = [];
                                for (var fi = 0; fi <= index; fi++) {
                                    newFormIDs.push(formIDs[fi]);
                                }
                                newFormIDs.push(objectID);
                                btn.onclick = function() {
                                    recreateMainTable(newFormIDs);
                                };
                            }

                            var omissChanceEntry = decodeValue(entry, "LVOV", "LVOC", "LVOT");
                            buildValueEntry(parent, omissChanceEntry, maxCols, "Omission chance", value => value.toFixed(3) + "%");

                            buildConditionEntry(parent, entry, maxCols);

                            n = parent.rows.length;
                            row = parent.insertRow(n);
                            cll = row.insertCell(row.cells.length);
                            cll.colSpan = 2;

                            cll = row.insertCell(row.cells.length);
                            cll.colSpan = Math.max(1, maxCols - 3);


                            // calculate entry chance
                            var entryChance = parentChance * (1 - omissChanceList.value / 100.0);
                            if (pickUniformRandom) {
                                entryChance *= 1.0 / lvli.Entries.length;
                            }
                            else if (firstPickFromAll) {
                                // mutual conditions on all entries keeps the parent+list chance
                                if (!checkConditionsMutual(entry.Conditions)) {
                                    entryChance *= picksSoFar * (1 - omissChanceEntry.value / 100.0);
                                    picksSoFar *= omissChanceEntry.value / 100;
                                }
                            } else {
                                entryChance *= (1 - omissChanceEntry.value / 100.0);
                            }
                            // calculate entry chance


                            var chanceTable = document.createElement("table");
                            cll.appendChild(chanceTable);
                            chanceTable.style.width = "100%";

                            row = chanceTable.insertRow(0);
                            cll = row.insertCell(0)
                            cll.style.fontWeight = "bold";
                            cll.innerText = "Drop chance (cumulative)";

                            cll = row.insertCell(1)
                            cll.style.textAlign = "right";
                            cll.style.fontWeight = "bold";
                            cll.innerText = (entryChance * 100.0).toFixed(3) + "%";
                            cll.style.border = "1px dotted red";
                            cll.style.color = "red";

                            if (objectGroup == "LVLI" && formIDs.length > index + 1 && formIDs[index + 1] == objectID) {
                                n = parent.rows.length;
                                row = parent.insertRow(n);

                                cll = row.insertCell(row.cells.length);
                                cll.colSpan = maxCols;
                                cll.style.paddingLeft = "40px";
                                cll.style.border = "1px solid black";

                                var innerTable = document.createElement("table");
                                cll.appendChild(innerTable);

                                generateTable(innerTable, formIDs, index + 1, entryChance);

                                btn.innerText = "Close";
                                let closeFormIDs = formIDs.slice(0, index + 1);
                                btn.onclick = function() {
                                    recreateMainTable(closeFormIDs);
                                };
                            }
                        }
                    }
                }
            }

            function recreateMainTable(formIDs) {
                var mainTable = document.getElementById("listtable");

                clear(mainTable);

                generateTable(mainTable, formIDs, 0, 1);

                var tableLink = document.getElementById("tableLink");

                var patchSel = document.getElementById("versionselect");
                var patch = patchSel.options[patchSel.selectedIndex].value;

                tableLink.href = "?patch=" + patch + "&formids=" + encodeURIComponent(formIDs.join("-"));
                tableLink.style.display = "inline";
            }

            function clear(table) {
                for (var i = table.rows.length - 1; i >= 0; i--) {
                    table.deleteRow(i);
                }
            }

            function showList(formID) {
                recreateMainTable([formID]);
            }

            function createIgnoreRow(resultsTable, ignoreFlag) {
                var n = resultsTable.rows.length;
                var row = resultsTable.insertRow(n);
                var cll = row.insertCell(row.cells.length);
                cll.colSpan = 3;
                cll.style.borderTop = "1px solid black";
                cll.style.textAlign = "center";
                cll.style.fontStyle = "italic";
                var txt = [];
                if ((ignoreFlag & 1) != 0) {
                    txt.push("Atom Shop");
                }
                if ((ignoreFlag & 2) != 0) {
                    txt.push("Cut content");
                }
                if ((ignoreFlag & 4) != 0) {
                    txt.push("Debug content");
                }
                cll.innerText = "Entries found but ignored due to options: " + txt.join(", ");
            }

            function searchLists() {
                var textField = document.getElementById("listsearchterm");
                var regexps = parseSearchText(textField.value);

                var resultsTable = document.getElementById("searchresults");

                clear(resultsTable);

                var includeATX = document.getElementById("IncludeATX").checked;
                var includeCut = document.getElementById("IncludeCut").checked;
                var includeDebug = document.getElementById("IncludeDebug").checked;

                var ignoreFlag = 0;

                var foundList = [];

                for (var formID in leveledLists) {
                    var editorId = getEditorID(formID).toLowerCase();
                    var match = false;

                    var nozeroFormID = formID.replace(/^0+/, "").toLowerCase();
                    while (nozeroFormID.charAt(0) == "0") {
                        nozeroFormID = nozeroFormID.substring(1);
                    }
                    
                    for (var regexp of regexps) {
                        if (regexp.test(nozeroFormID)) {
                            match = true;
                            break;
                        }
                        if (regexp.test(editorId)) {
                            match = true;
                            break;
                        }
                    }

                    if (match) {
                        if (!includeATX && editorId.startsWith("atx_")) {
                            ignoreFlag = ignoreFlag | 1;
                            continue;
                        }
                        if (!includeCut && (editorId.startsWith("zzz") || editorId.includes("cut"))) {
                            ignoreFlag = ignoreFlag | 2;
                            continue;
                        }
                        if (!includeDebug && editorId.includes("debug")) {
                            ignoreFlag = ignoreFlag | 4;
                            continue;
                        }

                        foundList.push(formID);
                    }
                }

                generateSearchResults(resultsTable, foundList, ignoreFlag);
            }

            function generateSearchResults(resultsTable, foundList, ignoreFlag) {

                if (document.getElementById("SortByEditorID").checked) {
                    foundList.sort((a, b) => {
                        var e1 = getEditorID(a);
                        var e2 = getEditorID(b);
                        return e1.localeCompare(e2);
                    });
                }

                for (var formID of foundList) {
                    var n = resultsTable.rows.length;
                    var row = resultsTable.insertRow(n);

                    if (n % 2 != 0) {
                        row.style.backgroundColor = "#E0E0E0";
                    }

                    /*
                    var cll = row.insertCell(row.cells.length);
                    cll.style.fontFamily = "monospace";
                    cll.innerText = getGroupID(formID);
                    */
                    
                    cll = row.insertCell(row.cells.length);
                    cll.style.fontFamily = "monospace";
                    cll.innerHTML = createListLink(formID, formID);

                    cll = row.insertCell(row.cells.length);
                    cll.style.fontFamily = "monospace";
                    cll.innerHTML = createListLink(formID, getEditorID(formID));

                    cll = row.insertCell(row.cells.length);
                    cll.innerHTML = "<a href='https://nukacrypt.com/database/json/" + formID + "' target='_blank' title='See Nukacrypt data.'>&#x2622;</a>"
                }

                if (ignoreFlag != 0) {
                    createIgnoreRow(resultsTable, ignoreFlag);
                } else
                if (resultsTable.rows.length == 0) {
                    var n = resultsTable.rows.length;
                    var row = resultsTable.insertRow(n);
                    var cll = row.insertCell(row.cells.length);

                    cll.innerText = "No leveled lists found.";
                }
            }

            function searchItems() {
                var textField = document.getElementById("itemsearchterm");
                var regexps = parseSearchText(textField.value);

                var resultsTable = document.getElementById("searchresults");

                clear(resultsTable);

                var includeATX = document.getElementById("IncludeATX").checked;
                var includeCut = document.getElementById("IncludeCut").checked;
                var includeDebug = document.getElementById("IncludeDebug").checked;

                var ignoreFlag = 0;

                var foundList = [];

                for (var formID in leveledLists) {
                    var editorId = getEditorID(formID).toLowerCase();
                    var lvli = leveledLists[formID];

                    var match = false;

                    if (lvli.Entries === undefined) {
                        continue;
                    }

                    outer:
                    for (var listEntries of lvli.Entries) {
                        var entryId = listEntries.Object;
                        var nozeroEntryID = entryId.replace(/^0+/, "").toLowerCase();
                        var entryEditorId = getEditorID(entryId).toLowerCase()

                        for (var regexp of regexps) {
                            if (regexp.test(nozeroEntryID)) {
                                match = true;
                                break outer;
                            }
                            if (regexp.test(entryEditorId)) {
                                match = true;
                                break outer;
                            }
                        }
                    }

                    if (match) {
                        if (!includeATX && editorId.startsWith("atx_")) {
                            ignoreFlag = ignoreFlag | 1;
                            continue;
                        }
                        if (!includeCut && (editorId.startsWith("zzz") || editorId.includes("cut"))) {
                            ignoreFlag = ignoreFlag | 2;
                            continue;
                        }
                        if (!includeDebug && editorId.includes("debug")) {
                            ignoreFlag = ignoreFlag | 4;
                            continue;
                        }

                        foundList.push(formID);
                    }
                }

                generateSearchResults(resultsTable, foundList, ignoreFlag);
            }

            document.getElementById("listsearchbtn").onclick = searchLists;
            document.getElementById("itemsearchbtn").onclick = searchItems;

            document.getElementById("listsearchterm").onkeydown = function(evt) {
                if (evt.keyCode == 13) {
                    searchLists();
                }
            };
            document.getElementById("itemsearchterm").onkeydown = function(evt) {
                if (evt.keyCode == 13) {
                    searchItems();
                }
            };

            document.getElementById("clearResults").onclick = function() {
                clear(document.getElementById("searchresults"));
            };

            var q = location.search;

            if (q.includes("patch=")) {
                var idx = q.indexOf("patch=");
                var jdx = q.indexOf("&", idx + 1);
                if (jdx < 0) {
                    jdx = q.length;
                }
                var patch = q.substring(6, jdx);
                var versionSelect = document.getElementById("versionselect");
                for (var i = 0; i < versionSelect.options.length; i++) {
                    var opt = versionSelect.options[i];
                    if (opt.value === patch) {
                        opt.selected = true;
                        break;
                    }
                }         
            }
            doLoad();
        </script>
    </body>
</html>
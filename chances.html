<html>
    <head>
        <title>Fallout 76 Drop Chances</title>
        <style>
            * {
                font-family: sans-serif;
                font-size: 20px;
            }
            td {
                padding: 2px;
            }
            
            table.infoTable {
               border: 1px solid black;
               border-collapse: collapse;
            }
            table.infoTable td {
               border: 1px solid black;
            }
        </style>
        <meta name="keywords" content="Fallout,Fallout 76,RNG,Random,Chances,Leveled,Leveled List,LVLI,Datamine">
    </head>
    <body>
        <center>
            <span style="font-size: 36px; font-weight: bold;">Fallout 76 Drop Chances (0.0.1)</span><br/>
            <br/>
            <br/>
            Select version:
            <select id='versionselect'>
                <option value='P19' selected='selected'>Update 19: 19th May, 2020 (latest)</option>
            </select>
            &nbsp;&nbsp;
            <button id='loadversion'>Load</button>
            &nbsp; (Note that the site downloads up to 3MB of data for the selected version!)
            <hr>
            <table>
                <tr>
                    <td id='listsearchtip'>
                    </td>
                    <td>
                        <input id='listsearchterm' type='text' style='width: 300px;' value='0045EC2C,00439874,00439714'>&nbsp;<button id='listsearchbtn'>Find</button>
                    </td>
                    <td style='width: 30px;'></td>
                    <td id='itemsearchtip'>

                    </td>
                    <td>
                        <input id='itemsearchterm' type='text' style='width: 300px;' value='*raven*'>&nbsp;<button id='itemsearchbtn'>Find</button>
                    </td>
                </tr>
            </table>
            <hr>
            <table id='searchresults'>

            </table>
            <hr>
            <table id='listtable'>

            </table>
        </center>
        <script>
            // property key is the FormID, property value is the Group string (4chars) concatenated with the EditorID
            var edids = {};
            // property key is the FormID, property value is the global float
            var globals = {};
            // property key is the FormID, property value is the leveled list object
            var leveledLists = {};
            // property key is the FormID, property value is an array of objects with the form { "x": 0, "y" : 0 }
            var curves = {};

            var downloadDone = 0;

            function allDownloaded() {
                document.getElementById("loadversion").disabled = false;
                // TODO 
                console.log(Object.keys(edids).length);
                console.log(Object.keys(globals).length);
                console.log(Object.keys(leveledLists).length);
                console.log(Object.keys(curves).length);

                // find cross references
                for (var listID in leveledLists) {

                    var lvli = leveledLists[listID];

                    if (lvli.Entries !== undefined) {
                        for (var entry of lvli.Entries) {

                            var refList = leveledLists[entry.Object];

                            if (refList !== undefined) {
                                if (refList.Parents === undefined) {
                                    refList.Parents = [];
                                }
                                refList.Parents.push(listID);
                            }
                        }
                    }
                }
            }

            function loadScript(src, callback) {
                var r = false;
                var s = document.createElement('script');
                s.type = 'text/javascript';
                s.src = src;
                s.onload = s.onreadystatechange = function() {
                    //console.log( this.readyState ); //uncomment this line to see which ready states are called.
                    if ( !r && (!this.readyState || this.readyState == 'complete') ) {
                        r = true;
                        callback(s);
                    }
                };
                var t = document.getElementsByTagName('script')[0];
                t.parentNode.insertBefore(s, t);
            }

            function doLoad() {
                document.getElementById("loadversion").disabled = true;

                var versionSelect = document.getElementById("versionselect");
                if (versionSelect.selectedIndex >= 0) {
                    downloadDone = 4;
                    var patchPrefix = 
                        // "https://akarnokd.github.com/rng-76/" +
                        versionSelect.options[versionSelect.selectedIndex].value + "_";

                    loadScript(patchPrefix + "SeventySix_EDIDs.js", node => {
                        if (--downloadDone == 0) {
                           allDownloaded();
                        }
                    });
                    loadScript(patchPrefix + "SeventySix_GLOBs.js", node => {
                        if (--downloadDone == 0) {
                           allDownloaded();
                        }
                    });
                    loadScript(patchPrefix + "SeventySix_LVLIs.js", node => {
                        if (--downloadDone == 0) {
                           allDownloaded();
                        }
                    });
                    loadScript(patchPrefix + "SeventySix_CURVs.js", node => {
                        if (--downloadDone == 0) {
                           allDownloaded();
                        }
                    });
                }
            }


            document.getElementById("loadversion").onclick = doLoad;

            var infoMap = new Map();
            infoMap.set("ListSearch", 
                "Enter the FormID (leading zeros can be omitted) or Editor ID of the leveled list to find."
                + "<br>Use * to indicate a wildcard (e.g., *Fasnacht*)."
                + "<br>Use commas to list alternative options."
                + "<br>Spaces and capitalization are ignored."
            );
            infoMap.set("ItemSearch", 
                "Enter the FormID (leading zeros can be omitted) or Editor ID of the item you want to locate in the leveled lists."
                + "<br>Use * to indicate a wildcard (e.g., *Fixer*)."
                + "<br>Use commas to list alternative options."
                + "<br>Spaces and capitalization are ignored."
            );

            // add HTML explanation marker
            function info(name) {
                return "&nbsp;<sup><a href='#' style='font-size: 14; font-weight: bold;' onclick='showinfo(this, \"" + name + "\"); return false;'>Tip</a></sup>";
            }

            // popup for explanation
            function showinfo(target, name) {
                var div = document.getElementById("InfoDiv" + name);
                if (div == null) {
                    var div = document.createElement("div");
                    div.style.border = "1px solid black";
                    div.style.padding = "3px";
                    div.style.position = "absolute";
                    div.style.backgroundColor = "#FFFFD0";
                    div.style.zIndex = 99;
                    div.id = "InfoDiv" + name;
                    var txt = infoMap.get(name);

                    if (txt == null) {
                        txt = "??? " + name + " ???";
                    }
                    txt += "<hr><font style='font-size: 14px'>Click to close.</font>";
                    div.innerHTML = txt;

                    target.parentElement.appendChild(div);
                    div.onclick = function() {
                        target.parentElement.removeChild(div);
                    }
                } else {
                    target.parentElement.removeChild(div);
                }
            }

            document.getElementById("listsearchtip").innerHTML = "Search leveled list " + info("ListSearch");
            document.getElementById("itemsearchtip").innerHTML = "Search item in lists " + info("ItemSearch");

            // paging support
            var searchResults = [];

            function parseSearchText(text) {

                var result = text.split(",");
                for (var i = 0; i < result.length; i++) {
                    // remove spaces
                    var entry = result[i];

                    entry = entry.replace(" ", "");;
                    entry = entry.replace(/\*/g, ".*");
                    entry = entry.replace(/^0+/, "");
                    entry = entry.toLowerCase();

                    result[i] = new RegExp("^" + entry + "$");
                }

                return result;
            }

            function getEditorID(formID) {
                var result = edids[formID];
                if (result !== undefined) {
                    return result.substring(4);
                }
                return "";
            }

            function getGroupID(formID) {
                var result = edids[formID];
                if (result !== undefined) {
                    return result.substring(0, 4);
                }
                return "";
            }

            function createListLink(formID, text) {
                return "<a href='#' onclick='showList(\"" + formID + "\"); return false;'>" + text + "</a>";
            }

            function interpolate(curveTable, x) {
                var first = curveTable[0];
                if (x <= first.x) {
                    return first.y;
                }
                var last = curveTable[curveTable.length - 1];
                if (last <= x) {
                    return last.y;
                }
                for (var i = 0; i < curveTable.length - 1; i++) {
                    var curr = curveTable[i];
                    var next = curveTable[i + 1];

                    if (curr.x <= x && x < next.x) {
                        var step = next.x - curr.x;
                        var raise = next.y - curr.y;

                        var xrate = (x - curr.x) / step;

                        var yrate = curr.y + raise * xrate;

                        return yrate;
                    }
                }
                return NaN;
            }

            function decodeValue(entry, keyDirect, keyGlobal, keyCurve) {
                var curveID = entry[keyCurve];
                var globalID = entry[keyGlobal];
                if (curveID !== undefined) {
                    var curveTable = curves[curveID];
                    if (curveTable !== undefined) {
                        if (globalID !== undefined) {
                            var globalValue = globals[globalID];
                            if (globalValue !== undefined) {
                                var v = interpolate(curveTable, globalValue);                            
                                return {
                                    type: "Curve",
                                    id: curveID,
                                    g: globalID,
                                    x: globalValue,
                                    value: v
                                };
                            }

                            return {
                                type: "Curve",
                                id: curveID,
                                x: globalID,
                                error: "Global value not found"
                            };
                        }
                        return {
                            type: "Curve",
                            id: curveID,
                            error: "Global reference entry missing"
                        }
                    }
                    return {
                        type: "Curve",
                        id: curveID,
                        error: "Curve table not found."
                    }
                }
                if (globalID !== undefined) {
                    var globalValue = globals[globalID];
                    if (globalValue !== undefined) {
                        return {
                            type: "Global",
                            id: globalID,
                            value: globalValue
                        };
                    }
                    return {
                        type: "Global",
                        id: globalID,
                        error: "Global value not found"
                    }
                }

                var direct = entry[keyDirect];
                if (direct === undefined) {
                    direct = 0;
                }

                return {
                    type: "Constant",
                    value: direct
                };
            }

            function createNukaLink(formID) {
                return "<a href='https://nukacrypt.com/database/json/" + formID + "' target='_blank' title='See Nukacrypt data.'>&#x2622;&nbsp;"
                    + getGroupID(formID) + ":" + formID + " &lt;" + getEditorID(formID) + "&gt;"
                    + "</a>";
            }

            function buildValueEntry(parent, omiss, maxCols, title, formatter) {
                n = parent.rows.length;
                row = parent.insertRow(n);
                cll = row.insertCell(row.cells.length);
                cll.colSpan = maxCols;
                cll.style.paddingLeft = "60px";

                var innerTbl = document.createElement("table");
                innerTbl.style.width = "100%";
                cll.appendChild(innerTbl);

                row = innerTbl.insertRow(0);
                cll = row.insertCell(0);

                cll.style.backgroundColor = "C0FFC0";

                var omissSpacer = "<br><span style='margin-left: 20px;'></span>";

                if (omiss.type === "Constant") {
                    cll.innerHTML = title + " (constant): <b>" + formatter(omiss.value) + "</b>";
                }
                else if (omiss.type === "Global") {
                    if (omiss.error === undefined) {
                        cll.innerHTML = title + " (global): <b>" + formatter(omiss.value) + "</b>" + omissSpacer
                            + createNukaLink(omiss.id)
                        ;
                    } else {
                        cll.innerHTML = title + " (global): <b style='color: red;'>" + omiss.error + "</b>" + omissSpacer
                            + createNukaLink(omiss.id)
                        ;
                    }
                }
                else if (omiss.type == "Curve") {
                    if (omiss.error === undefined) {
                        cll.innerHTML = title + " (curve): <b>" + formatter(omiss.value) + "</b>" + omissSpacer
                            + "Table: " + createNukaLink(omiss.id) + omissSpacer
                            + "Global: " + createNukaLink(omiss.g) + " = " + omiss.x
                        ;
                    } else {
                        cll.innerHTML = title + " (curve): <b style='color: red;'>" + omiss.error + "</b>" + omissSpacer
                            + "Table: " + createNukaLink(omiss.id)
                            + "Global: " + createNukaLink(omiss.g)
                        ;
                    }
                }
            }

            
            function generateTable(parent, formIDs, index, parentChance) {
                var formID = formIDs[index];

                var lvli = leveledLists[formID];
                var maxCols = 5;

                var n = parent.rows.length;
                var row = parent.insertRow(n);
                var cll = row.insertCell(row.cells.length);
                cll.innerHTML = getGroupID(formID) + ":" + formID + " &lt;" + getEditorID(formID) + "&gt; "
                    + "<a href='https://nukacrypt.com/database/json/" + formID + "' target='_blank' title='See Nukacrypt data.'>&#x2622;</a>"
                ;
                cll.style.backgroundColor = "#FFCC00";
                cll.style.fontWeight = "bold";
                cll.colSpan = maxCols;

                if (lvli === undefined) {
                    n = parent.rows.length;
                    row = parent.insertRow(n);
                    cll = row.insertCell(row.cells.length);

                    cll.innerText = "Table " + formID + " not found.";
                } else {
                    var omissChanceList = decodeValue(lvli, "LVCV", "LVLG", "LVCT");
                    buildValueEntry(parent, omissChanceList, maxCols, "Omission chance", value => value.toFixed(3) + "%");

                    var maxValueList = decodeValue(lvli, "LVMV", "LVMG", "LVMT");
                    buildValueEntry(parent, maxValueList, maxCols, "Max value", value => value + "");
                    var flagsList = lvli["LVLF"];

                    if (lvli.Parents !== undefined) {
                        var n = parent.rows.length;
                        var row = parent.insertRow(n);
                        var cll = row.insertCell(row.cells.length);
                        cll.colSpan = maxCols;
                        cll.innerText = "Referenced from (" + lvli.Parents.length + ")";
                        cll.style.backgroundColor = "#C0FFFF";
                        cll.style.fontWeight = "bold";

                        for (var ref of lvli.Parents) {
                            n = parent.rows.length;
                            row = parent.insertRow(n);

                            cll = row.insertCell(row.cells.length);

                            cll = row.insertCell(row.cells.length);
                            cll.style.fontFamily = "monospace";
                            cll.innerHTML = createListLink(ref, ref);

                            cll = row.insertCell(row.cells.length);
                            cll.style.fontFamily = "monospace";
                            cll.innerHTML = createListLink(ref, getEditorID(ref));

                            cll = row.insertCell(row.cells.length);
                            cll.innerHTML = "<a href='https://nukacrypt.com/database/json/" + ref + "' target='_blank' title='See Nukacrypt data.'>&#x2622;</a>"

                            cll = row.insertCell(row.cells.length);

                            var btn = document.createElement("button");
                            cll.appendChild(btn);

                            btn.innerText = "Chain";

                            let newFormIDs = [];
                            newFormIDs.push(ref);
                            for (var fi = index; fi < formIDs.length; fi++) {
                                newFormIDs.push(formIDs[fi]);
                            }

                            btn.onclick = function() {
                                var mainTable = document.getElementById("listtable");

                                clear(mainTable);

                                generateTable(mainTable, newFormIDs, 0, 1);
                            };
                            if (index > 0 && formIDs[index - 1] == ref) {
                                btn.disabled = true;
                            }
                        }
                    }

                    if (lvli.Conditions !== undefined) {

                        n = parent.rows.length;
                        row = parent.insertRow(n);
                        cll = row.insertCell(row.cells.length);

                        cll.innerText = "Conditions (" + lvli.Conditions.length + ")";
                        cll.style.backgroundColor = "#C0C0FF";
                        cll.style.fontWeight = "bold";
                        cll.colSpan = maxCols;
                    }
                    if (lvli.Entries !== undefined) {

                        var useAll = (flagsList & 4) != 0;
                        var entryBaseChance = 1;

                        n = parent.rows.length;
                        row = parent.insertRow(n);
                        cll = row.insertCell(row.cells.length);

                        cll.innerText = "Entries (" + lvli.Entries.length + ")";
                        cll.style.backgroundColor = "#C0C0FF";
                        cll.style.fontWeight = "bold";
                        cll.colSpan = maxCols;

                        for (var entry of lvli.Entries) {
                            n = parent.rows.length;
                            row = parent.insertRow(n);

                            var objectID = entry.Object;
                            var objectEDIDFull = edids[objectID];
                            var objectGroup = "";
                            var objectName = "";
                            if (objectEDIDFull !== undefined) {
                                objectGroup = objectEDIDFull.substring(0, 4);
                                objectName = objectEDIDFull.substring(4);
                            }

                            cll = row.insertCell(row.cells.length);
                            cll.style.fontFamily = "monospace";
                            cll.innerText = objectGroup;

                            cll = row.insertCell(row.cells.length);
                            cll.style.fontFamily = "monospace";
                            if (objectGroup == "LVLI") {
                                cll.innerHTML = createListLink(objectID, objectID);
                            } else {
                                cll.innerText = objectID;
                            }

                            cll = row.insertCell(row.cells.length);
                            cll.style.fontFamily = "monospace";
                            if (objectGroup == "LVLI") {
                                cll.innerHTML = createListLink(objectID, objectName);
                            } else {
                                cll.innerText = objectName;
                            }

                            cll = row.insertCell(row.cells.length);
                            cll.innerHTML = "<a href='https://nukacrypt.com/database/json/" + objectID + "' target='_blank' title='See Nukacrypt data.'>&#x2622;</a>"

                            if (objectGroup == "LVLI") {
                                cll = row.insertCell(row.cells.length);
                                var btn = document.createElement("button");
                                btn.innerText = "Open";
                                cll.appendChild(btn);

                                let newFormIDs = [];
                                for (var fi = 0; fi <= index; fi++) {
                                    newFormIDs.push(formIDs[fi]);
                                }
                                newFormIDs.push(objectID);
                                btn.onclick = function() {
                                    var mainTable = document.getElementById("listtable");

                                    clear(mainTable);

                                    generateTable(mainTable, newFormIDs, 0, 1);
                                };
                            }

                            var omissChanceEntry = decodeValue(entry, "LVOV", "LVOC", "LVOT");
                            buildValueEntry(parent, omissChanceEntry, maxCols, "Omission chance", value => value.toFixed(3) + "%");

                            var entryCascadingChance = 1;

                            if (objectGroup == "LVLI" && formIDs.length > index + 1 && formIDs[index + 1] == objectID) {
                                n = parent.rows.length;
                                row = parent.insertRow(n);

                                cll = row.insertCell(row.cells.length);
                                cll.colSpan = maxCols;
                                cll.style.paddingLeft = "40px";
                                cll.style.border = "1px solid black";

                                var innerTable = document.createElement("table");
                                cll.appendChild(innerTable);

                                generateTable(innerTable, formIDs, index + 1, entryCascadingChance);

                                btn.innerText = "Close";
                                let closeFormIDs = formIDs.slice(0, index + 1);
                                btn.onclick = function() {
                                    var mainTable = document.getElementById("listtable");

                                    clear(mainTable);

                                    generateTable(mainTable, closeFormIDs, 0, 1);
                                };
                            }
                        }
                    }
                }
            }

            function clear(table) {
                for (var i = table.rows.length - 1; i >= 0; i--) {
                    table.deleteRow(i);
                }
            }

            function showList(formID) {
                var listTable = document.getElementById("listtable");

                clear(listTable);

                generateTable(listTable, [formID], 0, 1);
            }

            function searchLists() {
                var textField = document.getElementById("listsearchterm");
                var regexps = parseSearchText(textField.value);

                var resultsTable = document.getElementById("searchresults");

                clear(resultsTable);

                for (var formID in leveledLists) {
                    var editorId = getEditorID(formID).toLowerCase();
                    var match = false;

                    var nozeroFormID = formID.replace(/^0+/, "").toLowerCase();
                    while (nozeroFormID.charAt(0) == "0") {
                        nozeroFormID = nozeroFormID.substring(1);
                    }
                    
                    for (var regexp of regexps) {
                        if (regexp.test(nozeroFormID)) {
                            match = true;
                            break;
                        }
                        if (regexp.test(editorId)) {
                            match = true;
                            break;
                        }
                    }

                    if (match) {
                        var n = resultsTable.rows.length;
                        var row = resultsTable.insertRow(n);

                        if (n % 2 != 0) {
                            row.style.backgroundColor = "#E0E0E0";
                        }

                        /*
                        var cll = row.insertCell(row.cells.length);
                        cll.style.fontFamily = "monospace";
                        cll.innerText = getGroupID(formID);
                        */
                        
                        cll = row.insertCell(row.cells.length);
                        cll.style.fontFamily = "monospace";
                        cll.innerHTML = createListLink(formID, formID);

                        cll = row.insertCell(row.cells.length);
                        cll.style.fontFamily = "monospace";
                        cll.innerHTML = createListLink(formID, getEditorID(formID));

                        cll = row.insertCell(row.cells.length);
                        cll.innerHTML = "<a href='https://nukacrypt.com/database/json/" + formID + "' target='_blank' title='See Nukacrypt data.'>&#x2622;</a>"
                    }
                }

                if (resultsTable.rows.length == 0) {
                    var n = resultsTable.rows.length;
                    var row = resultsTable.insertRow(n);
                    var cll = row.insertCell(row.cells.length);

                    cll.innerText = "No leveled lists found.";
                }
            }

            function searchItems() {
                var textField = document.getElementById("itemsearchterm");
                var regexps = parseSearchText(textField.value);

                var resultsTable = document.getElementById("searchresults");

                clear(resultsTable);

                for (var formID in leveledLists) {
                    var editorId = getEditorID(formID).toLowerCase();
                    var lvli = leveledLists[formID];

                    var match = false;

                    if (lvli.Entries === undefined) {
                        continue;
                    }

                    outer:
                    for (var listEntries of lvli.Entries) {
                        var entryId = listEntries.Object;
                        var nozeroEntryID = entryId.replace(/^0+/, "").toLowerCase();
                        var entryEditorId = getEditorID(entryId).toLowerCase()

                        for (var regexp of regexps) {
                            if (regexp.test(nozeroEntryID)) {
                                match = true;
                                break outer;
                            }
                            if (regexp.test(entryEditorId)) {
                                match = true;
                                break outer;
                            }
                        }
                    }

                    if (match) {
                        var n = resultsTable.rows.length;
                        var row = resultsTable.insertRow(n);

                        if (n % 2 != 0) {
                            row.style.backgroundColor = "#E0E0E0";
                        }

                        /*
                        var cll = row.insertCell(row.cells.length);
                        cll.style.fontFamily = "monospace";
                        cll.innerText = getGroupID(formID);
                        */
                        
                        cll = row.insertCell(row.cells.length);
                        cll.style.fontFamily = "monospace";
                        cll.innerHTML = createListLink(formID, formID);

                        cll = row.insertCell(row.cells.length);
                        cll.style.fontFamily = "monospace";
                        cll.innerHTML = createListLink(formID, getEditorID(formID));

                        cll = row.insertCell(row.cells.length);
                        cll.innerHTML = "<a href='https://nukacrypt.com/database/json/" + formID + "' target='_blank'>&#x2622;</a>"
                    }
                }

                if (resultsTable.rows.length == 0) {
                    var n = resultsTable.rows.length;
                    var row = resultsTable.insertRow(n);
                    var cll = row.insertCell(row.cells.length);

                    cll.innerText = "No leveled lists found.";
                }
            }

            document.getElementById("listsearchbtn").onclick = searchLists;
            document.getElementById("itemsearchbtn").onclick = searchItems;

            document.getElementById("listsearchterm").onkeydown = function(evt) {
                if (evt.keyCode == 13) {
                    searchLists();
                }
            };
            document.getElementById("itemsearchterm").onkeydown = function(evt) {
                if (evt.keyCode == 13) {
                    searchItems();
                }
            };

            doLoad();
        </script>
    </body>
</html>